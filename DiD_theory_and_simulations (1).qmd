Super fichier
---
title: "DiD tests"
format: html
---

```{r}
# install.packages("devtools")
# devtools::install_github("bcallaway11/did", force=TRUE)
library(did)
library(plm)
library(ggplot2)
```

# Two groups / two periods

The "canonical" version of DiD involves two periods and two groups. The untreated group never participates in the treatment, and the treated group becomes treated in the second period.

The leading approach in applied work is to try to estimate the effect of the treatment using a two-way fixed effects (TWFE) linear regression. This works great in the case with two periods, but there are a number of recent methodological papers that suggest that there may be substantial drawbacks to using TWFE with multiple time periods.

## Theory & assumptions

We define the following model:

$$Y_{i,t}=D_i*Y_{i,t}(1)+(1-D_i)Y_{i,t}(0)$$

With :

-   $Y_{i,t}(0)$ the outcome that unit i would experience in period $t$ if they did not participate in the treatment;

-   $Y_{i,t}(1)$ the outcome that unit i would experience in period $t$ if they did participate in the treatment;

-   $D=1$ for units in the treated group and $D=0$ for units in the untreated group.

The main parameter of interest in most DiD designs is the **Average Treatment Effect** on the Treated (ATT). It is given by $$ATT=E[Y_t(1)-Y_t(0)|D=1]$$ This is the difference between treated and untreated potential outcomes, on average, for units in the treated group.

The main assumption in DiD designs is called the **Parallel Trends Assumption**: $$E[Y_t(0)-Y_{t-1}(0)|D=1]=E[Y_t(0)-Y_{t-1}|D=0]$$ In words, this assumption says that the change (or "path") in outcomes over time that units in the treated group would have experienced if they had not participated in the treatment is the same as the path of outcomes that units in the untreated group actually experienced.

Under the parallel trends assumption, the **ATT** is identified and given by $$ATT=E[Y_t-Y_{t-1}|D=1]-E[Y_t-Y_{t-1}|D=0]$$

By far the most common approach to trying to estimate the effect of a binary treatment in this setup is the **Two way fixed effects regressions (TWFE)** linear regression.

$$Y_{i,t}=\theta_t+\eta_i+\alpha D_{i,t}+ \nu_{i,t}$$ where: - $\theta_t$ is a time fixed effect, - $\eta_i$ is a unit fixed effect, - $D_{i,t}$ is a treatment dummy variable, - $\nu_{i,t}$ are time varying unobservables that are mean independent of everything else - $\alpha$ is presumably the parameter of interest. It is often interpreted as the average effect of participating in the treatment.

**When will TWFE work?**

-   **Effects really aren't heterogeneous.** If the effect of participating in the treatment really is $\alpha$ for all units, TWFE will work great.

    That being said, in many applications, treatment effects are very likely to be heterogeneous, they may vary across different units or exhibit dynamics or change across different time periods. In particular applications, this is worth thinking about, but, at least in our view, we think that heterogeneous effects of participating in some treatment is the leading case.

-   **There are only two time periods.** This is the canonical case (2 periods, one group becomes treated in the second period, the other is never treated). In this case, under parallel trends and no-anticipation, $\alpha$ is going to be numerically equal to the ATT. In other words, in this case, even though it looks like you have restricted the effect of participating in the treatment to be the same across all units, TWFE exhibits robustness to treatment effect heterogeneity.

    Unfortunately, this robustness to treatment effect heterogeneity does not continue to hold when there are more periods and groups become treated at different points in time.

## Analysis





# Multiple groups / multiple periods

## Theory & assumptions

### Notations

Now let's move to a more general case where there are $T$ total time periods. Denote particular time periods by $t$ where $t=1,â€¦,T$.

Let's first provide some extended notation:

-   $Y_{i,t}(0)$ is unit i's untreated potential outcome. This is the outcome that unit i would experience in period $t$ if they do not participate in the treatment.

-   $Y_{i,t}(g)$ is unit i's potential outcome in time period $t$ if they become treated in period g.

-   $G_i$ is the time period when unit i becomes treated (often groups are defined by the time period when a unit becomes treated; hence, the G notation).

-   $C_i$ is an indicator variable for whether unit i is in a never-treated group.

-   $D_{i,t}$ is an indicator variable for whether unit i has been treated by time $t$.

-   $Y_{i,t}$ is unit i's observed outcome in time period t.

-   $X_i$ a vector of pre-treatment covariates.

For units in the never-treated group, $Y_{i,t}=Y_{i,t}(0)$ in all time periods. For units in other groups, we observe $$Y_{i,t}=1_{G_i>t}*Y_{i,t}(0)+1_{G_i \leq t}Y_{i,t}(G_i)$$.

### Main assumptions

**Staggered Treatment Adoption Assumption**: Recall that $D_{i,t}=1$ if a unit i has been treated by time t and $D_{i,t}=0$ otherwise. Then, for $t=1,...,T-1$, if $D_{i,t}=1$ then $D_{i,t+1}=1$.

*Staggered treatment* adoption implies that once a unit participates in the treatment, they remain treated. In other words, units do not "forget" about their treatment experience.

**Parallel Trends Assumption based on never-treated units**: For all $g=2,...,T$ and $t=2,...,T$, with $t\geq g$, we have $$E[Y_t(0)-Y_{t-1}(0)|G=g]=E[Y_t(0)-Y_{t-1}(0)|C=1]$$

This is a natural extension of the parallel trends assumption in the two periods and two groups case. It says that, in the absence of treatment, average untreated potential outcomes for the group first treated in time g and for the "never treated" group would have followed parallel paths in all post-treatment periods $t \geq g$.

This presumes that **(i)** a (large enough) "never-treated" group is available in the data, and **(ii)** these units are "similar enough" to the eventually treated units such that they can indeed be used as a valid comparison group.

In situations where these conditions are not satisfied, one can use an alternative parallel trends assumption that uses the not-yet treated units as valid comparison groups.

**Parallel Trends Assumption based on not-yet treated units**: For all $g=2,...,T$, $s,t=2,...,T$ with $t \geq g$ and $s \geq t$ we assume $$E[Y_t(0)-Y_{t-1}(0)|G=g]=E[Y_t(0)-Y_{t-1}(0)|D_s=0,G \neq g]$$

In plain English, this assumption states that one can use the not-yet-treated by time s $(s \geq t)$ units as valid comparison groups when computing the average treatment effect for the group first treated in time $g$.

**Parallel Trends Conditional on Covariates**:

In many cases, the parallel trends assumption is substantially more plausible if it holds after conditioning on observed pre-treatment covariates. In other words, if the parallel trends assumptions are modified to be:

-   **Conditional Parallel Trends Assumption based on never-treated units**: For all $g=2,...,T$ and $t=2,...,T$ with $t \geq g$ we get $$E[Y_t(0)-Y_{t-1}(0)|X,G=g]=E[Y_t(0)-Y_{t-1}(0)|X,C=1]$$.

-   **Parallel Trends Assumption based on not-yet treated units**: For all $g=2,...,T$ and $s,t=2,...,T$ with $t \geq g$ and $s \geq t$ we get $$E[Y_t(0)-Y_{t-1}(0)|X,G=g]=E[Y_t(0)-Y_{t-1}(0)|X,D_s=0,G \neq g]$$.

Importantly, this assumptions allow for covariate-specific trends in outcomes across groups, which can be particularly important in setups where the distribution of covariates varies across groups. An example of a case where this assumption is attractive is one where a researcher is interested in estimating the effect of participating in job training on earnings. In that case, if the path of earnings (in the absence of participating in job training) depends on things like education, previous occupation, or years of experience (which it almost certainly does), then it would be important to condition on these types of variables in order to make parallel trends more credible.

### Parameters of interest

**Group-Time Average Treatment Effects**:

A natural way to generalize the parameter of interest (the **ATT**) from the two periods and two groups case to the multiple periods case is to define group-time average treatment effects: $$ATT(g,t)=E[Y_t(g)-Y_t(0)|G=g]$$

This is the average effect of participating in the treatment for units in group $g$ at time period $t$.

Under either version of the parallel trends assumptions mentioned above, it is straightforward to show that group-time average treatment effects are identified:

-   Suppose the parallel trends assumption based on *"never-treated units"*, we have that, for all $t \geq g$, $ATT(g,t)=E[Y_t-Y_{g-1}|G=g]-E[Y_t-Y_{g-1}|C=1]$.

-   Suppose the parallel trends assumption based on *"not-yet-treated units"*, we have that, for all $t \geq g$, $ATT(g,t)=E[Y_t-Y_{g-1}|G=g]-E[Y_t-Y_{g-1}|D_t=0,G \neq g]$.

These group-time average treatment effects are the building blocks of understanding the effect of participating in a treatment in DiD designs with multiple time periods.

When considering parallel trends conditional on some covariates, **ATT** is still the parameter of interest and one needs to estimate the change in outcomes for units in the untreated group conditional on X, but average out X over the distribution of covariates for individuals in group g to obtain $ATT(g,t)$.

**Aggregating Group-Time Average Treatment Effects**:

Group-time average treatment effects are natural parameters to identify in the context of DiD with multiple periods and multiple groups. But in many applications, there may be a lot of them. There are some benefits and costs here. The main benefit is that it is relatively straightforward to think about heterogeneous effects across groups and time using group-time average treatment effects. On the other hand, it can be hard to summarize them (e.g., they are not just a single number).

There are plenty of possible ways to aggregate $ATT(g,t)$:

-   First, consider the average effect of participating in the treatment, separately for each group. This is given by $$\theta_S(g)=\frac{1}{T-g+1} \sum_{t=2}^{T} 1_{g \leq t} ATT(g,t)$$

-   Furthermore, it is fairly straightforward to further aggregate $\theta_S(g)$ to get an easy-to-interpret overall effect parameter, $$\theta^O_S:= \sum_{g=2}^{T} \theta_S(g) P(G=g)$$ $\theta^O_S$ is the overall effect of participating in the treatment across all groups that have ever participated in the treatment. This is close to being a multi-period analogue of the ATT in the two period case.

-   Understanding treatment effect dynamics, in line with event-study-type of analysis. In this case, a natural way to aggregate the group-time average treatment effect to highlight treatment effect dynamics is given by $$\theta_D(e):= \sum_{g=2}^{T} 1_{g+e \leq T} ATT(g,g+e) P(G=g|G+e \leq T)$$

## Analysis

### Simulated data

```{r, echo=FALSE}
set.seed(1814)
```

We simulate a four periods dataset

```{r}
# set simulation parameters
# (main thing: it generates a dataset that satisfies
# parallel trends in all periods...including pre-treatment)
time.periods = 4

sim_parameters = reset.sim(time.periods = time.periods, n = 5000, ipw = TRUE, reg = TRUE)

# generate dynamic effects
sim_parameters$te.e = 1:time.periods

# generate data set
data <- build_sim_dataset(sim_parameters)

head(data)
```

The function simulates a data set with the following attributes:

-   **G**: observations group
-   **X**: value of covariate
-   **id**: observation's id
-   **cluster**: observation's cluster (by construction there is no within-cluster correlation)
-   **period**: time period for current observation
-   **Y**: outcome
-   **treat**: whether or not this unit is ever treated

### Assumption testing

The objective here is to test the parallel trend assumption.

#### Standard parallel trend assumption testing

-   **Event-study regression approach**:

By far the most common approach to pre-testing in applications is to run an event-study regression. $$Y_{i,t}=\theta_t+\eta_i+\sum_{l=-T}^{T-1} D^l_{i,t} \mu_l + \nu_{i,t}$$ where $D^l_{i,t}=1$ if individual i has been exposed to the treatment for l periods in period t, and $D^l_{i,t}=0$ otherwise and $\mu_l$ is interpreted as the effect of treatment for different lengths of exposure to the treatment.

```{r}
#-----------------------------------------------------------------------------
# modify the dataset a bit so that we can run an event study
#-----------------------------------------------------------------------------

# generate leads and lags of the treatment
Dtl <- sapply(-(time.periods-1):(time.periods-2), function(l) {
    dtl <- 1*( (data$period == data$G + l) & (data$G > 0) )
    dtl
})
Dtl <- as.data.frame(Dtl)
cnames1 <- paste0("Dtmin", (time.periods-1):1)
colnames(Dtl) <- c(cnames1, paste0("Dt", 0:(time.periods-2)))
data <- cbind.data.frame(data, Dtl)
row.names(data) <- NULL

head(data)
```

```{r}
#-----------------------------------------------------------------------------
# run the event study regression
#-----------------------------------------------------------------------------

# run event study regression
# normalize effect to be 0 in pre-treatment period
es <- plm(Y ~ Dtmin3 + Dtmin2 + Dt0 + Dt1 + Dt2, 
          data = data, model = "within", effect = "twoways",
          index = c("id", "period"))

summary(es)
```

```{r}
#-----------------------------------------------------------------------------
# make an event study plot
#-----------------------------------------------------------------------------

# some housekeeping for making the plot
# add 0 at event time -1
coefs1 <- coef(es)
ses1 <- sqrt(diag(summary(es)$vcov))
idx.pre <- 1:(time.periods-2)
idx.post <- (time.periods-1):length(coefs1)
coefs <- c(coefs1[idx.pre], 0, coefs1[idx.post])
ses <- c(ses1[idx.pre], 0, ses1[idx.post])
exposure <- -(time.periods-1):(time.periods-2)

cmat <- data.frame(coefs=coefs, ses=ses, exposure=exposure)

ggplot(data = cmat, mapping = aes(y = coefs, x = exposure)) +
  geom_line(linetype = "dashed") +
  geom_point() + 
  geom_errorbar(aes(ymin = (coefs-1.96*ses), ymax = (coefs+1.96*ses)), width = 0.2) +
  ylim(c(-2, 5)) +
  theme_bw()
```

**Probl?me:** pour l'instant je n'arrive pas ? simuler un dataframe o? l'hypoth?se de parallel trend est v?rifi?e... Notamment, je ne comprends pas le pram?tre \$te.e qui g?n?re une soit-disant dynamique.

-   **DiD package approach**:

```{r}
# estimate group-group time average treatment effects
did_att_gt <- att_gt(yname = "Y",
                     tname = "period",
                     idname = "id",
                     gname = "G",
                     data = data,
                     bstrap = TRUE, # set to FALSE for pointwise confidence intervals for group-time average treatment effects
                     cband = TRUE) # set to FALSE for pointwise confidence intervals for group-time average treatment effects

summary(did_att_gt)
```

```{r}
# aggregate them into event study plot
did_es <- aggte(did_att_gt, type = "dynamic")

# plot the event study
ggdid(did_es)
```

Si le *Pre* treatment has a coefficient close to zero, then the parallel trend assumption holds.

#### Group-time average treatment effects

**Selective treatment timing** means that individuals in different groups experience systematically different effects of participating in the treatment from individuals in other groups. For example, there would be selective treatment timing if individuals choose to be treated in earlier periods if they tend to experience larger benefits from participating in the treatment. This sort of selective treatment timing is likely to be present in many applications in economics / policy evaluation.

When there is **selective treatment timing** then $\mu_l$ end up being weighted averages of treatment effects across different lengths of exposures.

Contrary to event study regressions, pre-tests based on group-time average treatment effects (or based on group-time average treatment effects that are aggregated into an event study plot) are still valid even in the presence of selective treatment timing.

```{r}
# generate selective treatment timing
# (*** this is what is different here ***)
sim_parameters$te.bet.ind = time.periods:1 / (time.periods/2)

# generate data set
data <- build_sim_dataset(sim_parameters)
```

-   **Event-study regression approach**:

```{r}
# generate leads and lags of the treatment
Dtl <- sapply(-(time.periods-1):(time.periods-2), function(l) {
    dtl <- 1*( (data$period == data$G + l) & (data$G > 0) )
    dtl
})
Dtl <- as.data.frame(Dtl)
cnames1 <- paste0("Dtmin", (time.periods-1):1)
colnames(Dtl) <- c(cnames1, paste0("Dt", 0:(time.periods-2)))
data <- cbind.data.frame(data, Dtl)
row.names(data) <- NULL

# run event study regression
# normalize effect to be 0 in pre-treatment period
es <- plm(Y ~ Dtmin3 + Dtmin2 + Dt0 + Dt1 + Dt2, 
          data = data, model = "within", effect = "twoways", 
          index = c("id", "period"))

summary(es)
```

```{r}
# some housekeeping for making the plot
# add 0 at event time -1
coefs1 <- coef(es)
ses1 <- sqrt(diag(summary(es)$vcov))
idx.pre <- 1:(time.periods-2)
idx.post <- (time.periods-1):length(coefs1)
coefs <- c(coefs1[idx.pre], 0, coefs1[idx.post])
ses <- c(ses1[idx.pre], 0, ses1[idx.post])
exposure <- -(time.periods-1):(time.periods-2)

cmat <- data.frame(coefs=coefs, ses=ses, exposure=exposure)

# new event study plot
ggplot(data = cmat, mapping = aes(y = coefs, x = exposure)) +
  geom_line(linetype = "dashed") +
  geom_point() + 
  geom_errorbar(aes(ymin = (coefs-1.96*ses), ymax = (coefs+1.96*ses)), width = 0.2) +
  ylim(c(-2, 5)) +
  theme_bw()
```

-   **DiD package approach**:

```{r}
# estimate group-group time average treatment effects
did.att.gt <- att_gt(yname = "Y",
                     tname = "period",
                     idnam = "id",
                     gname = "G",
                     data = data
                     )
# summary(did.att.gt)

# aggregate them into event study plot
did.es <- aggte(did.att.gt, type = "dynamic")

# plot the event study
ggdid(did.es)
```

### Effect estimation

The did package is only built to handle **staggered treatment adoption designs**. This means that once an individual becomes treated, they remain treated in all subsequent periods.

-   Estimating **group-time average treatment effects**:

```{r}
# estimate group-time average treatment effects using att_gt method
example_attgt <- att_gt(yname = "Y",
                        tname = "period",
                        idname = "id",
                        gname = "G",
                        xformla = ~X,
                        data = data
                        )

# summarize the results
summary(example_attgt)
```

```{r}
# plot the results
ggdid(example_attgt)
```

-   **Aggregating group-time average treatment effects**:

We can compute a simple aggregation :

```{r}
agg.simple <- aggte(example_attgt, type = "simple")
summary(agg.simple)
```

Or get the dynamic effect:

```{r}
agg.es <- aggte(example_attgt, type = "dynamic")
summary(agg.es)
ggdid(agg.es)
```

-   **Group-Specific Effects**:

Another idea is to look at average effects specific to each group. It is also straightforward to aggregate group-time average treatment effects into group-specific average treatment effects.

```{r}
agg.gs <- aggte(example_attgt, type = "group")
summary(agg.gs)
ggdid(agg.gs)
```

-   **Selecting Alternative Control Groups**:

By default, the did package uses the group of units that never participate in the treatment as the control group. In this case, if there is no group that never participates, then the did package will drop the last period and set units that do not become treated until the last period as the control group (this will also throw a warning). The other option for the control group is to use the "not yet treated". The "not yet treated" include the never treated as well as those units that, for a particular point in time, have not been treated yet (though they eventually become treated). This group is at least as large as the never treated group though it changes across time periods. To use the "not yet treated" as the control, set the option control_group="notyettreated".

```{r}
example_attgt_altcontrol <- att_gt(yname = "Y",
                                   tname = "period",
                                   idname = "id",
                                   gname = "G",
                                   xformla = ~X,
                                   data = data,
                                   control_group = "notyettreated"          
                                   )
summary(example_attgt_altcontrol)
```

-   **Repeated cross sections**:

The did package can also work with repeated cross section rather than panel data. If the data is repeated cross sections, simply set the option panel = FALSE. In this case, idname is also ignored. From a usage standpoint, everything else is identical to the case with panel data.

-   **Unbalanced Panel Data**:

By default, the did package takes in panel data and, if it is not balanced, coerces it into being a balanced panel by dropping units with observations that are missing in any time period. However, if the user specifies the option allow_unbalanced_panel = TRUE, then the did package will not coerce the data into being balanced. Practically, the main cost here is that the computation time will increase in this case.

# Continuous treatment / multiple periods
