```{r}
library(dplyr)
library(lubridate)


Covalence_final <- select(Covalence_AllData, date, ISIN, CON_fina)

noESG_final  <- select(noESG_Funds_Holdings_All, fund_Isin, weight, date, isin)

library(dplyr)


#On arrange les dates
noESG_final <- noESG_final %>%
  arrange(fund_Isin, isin, date) %>%
  group_by(fund_Isin, isin) %>%
  mutate(delta_weight = weight - dplyr::lag(weight))



noESG_final$date <- as.character(noESG_final$date)

noESG_final$date <- paste(substr(noESG_final$date, 1, 4), substr(noESG_final$date, 5, 6), sep="-")
```


```{r}
merged_final <- merge(noESG_final, Covalence_final, by.x = c("isin", "date"), by.y = c("ISIN", "date"))
```

```{r}
# Assurer que la colonne date est bien au format Date
merged_final$date <- ymd(paste0(merged_final$date, "-01"))
# Définir la date de référence une seule fois
reference_date <- ymd("2013-01-01")

# Calcul vectorisé des mois écoulés depuis la date de référence
merged_final$nb_mois <- interval(start = reference_date, end = merged_final$date) / months(1)

```

```{r}
merged_final <- merged_final %>%
  rename(Outcome = delta_weight)
```


```{r}
merged_final <- merged_final %>%
  rename(id = isin)

merged_final <- merged_final %>%
  rename(time = nb_mois)

```


```{r}
fonction_did <- function(data, merged_US74){
  # Assurer que 'date' et 'id' sont dans l'ordre attendu et calculer 'Post'
  data <- data %>%
    group_by(id) %>%
    arrange(id, date) %>%
    mutate(Post = ifelse(CON_fina > 2 * dplyr::lag(CON_fina, default = first(CON_fina)), 1, 0))
  
  # Calculer cummax de 'Post' pour identifier si Post a jamais été 1 auparavant
  data <- data %>%
    mutate(Post = ifelse(cummax(Post) == 1, 1, 0)) 

  # Calculer 'TreatmentPeriod' et éviter de perdre les autres colonnes
  data <- data %>%
    mutate(TreatmentPeriod = ifelse(any(Post == 1), min(time[Post == 1], na.rm = TRUE), 0))
  
  # Ajouter 'Group' en utilisant 'TreatmentPeriod'
  data <- data %>%
    mutate(Group = paste("Group", TreatmentPeriod, sep = " "))
  
  # Modélisation linéaire
  diD_model <- lm(Outcome ~ Post + time + Post:time + Group - 1, data = data)
  
  # Extraire le coefficient de 'Post'
  post_coefficient <- coef(diD_model)["Post"]
  
  return(post_coefficient)
}

# Application de la fonction sur les données groupées par 'fund_Isin'
result <- merged_final %>%
  group_by(fund_Isin) %>%
  summarize(result = fonction_did(.))
```


```{r}
# on prend le fond : US74440N1028 par exemple

merged_US74 <- filter(merged_final, fund_Isin == "US74440N1028")


merged_US74 <- merged_US74 %>%
  group_by(id) %>%
  arrange(id, date) %>%
  mutate(Post = ifelse(CON_fina > 10 * dplyr::lag(CON_fina, default = first(CON_fina)), 1, 0))


```

```{r}
# Trier la base de données par entreprise (id) et par date
merged_US74 <- merged_US74 %>% arrange(id, date)

# Regrouper les données par entreprise (id)
merged_US74 <- merged_US74 %>%
  group_by(id) %>%
  # Créer une nouvelle colonne pour indiquer si l'entreprise est traitée à partir de cette date
mutate(Post = ifelse(cummax(Post) == 1, 1, 0)) %>%
  ungroup()  


merged_US74 <- merged_US74 %>%
  group_by(id) %>%
  # Calcul de la période de traitement avec remplacement des NA par 0
  dplyr::summarise(TreatmentPeriod = ifelse(any(Post == 1), min(time[Post == 1], na.rm = TRUE), 0)) %>%
  # Fusion avec le dataframe original
  dplyr::left_join(merged_US74, by = "id")


merged_US74 <- merged_US74 %>%
  group_by(id) %>%
  mutate(treated = ifelse(any(Post == 1), 1, 0)) %>%
  ungroup()


# Créer la colonne Group
merged_US74 <- merged_US74 %>%
  mutate(Group = paste("Group", TreatmentPeriod, sep = " "))
```


```{r}
# Plot the simulated data
ggplot2::ggplot(merged_US74, ggplot2::aes(x = time, y = Outcome, color = Group, linetype = factor(Post))) +
  ggplot2::geom_point() +
  ggplot2::labs(x = "Time", y = "Outcome", color = "Group", linetype = "Post") +
  ggplot2::theme_minimal()
```

```{r}
# Estimer les paramètres DiD en utilisant une régression linéaire
diD_model <- lm(Outcome ~ Post + time + Post:time + Group - 1, data = merged_US74)

# Extraire uniquement le coefficient estimé pour 'Post'
post_coefficient <- coef(diD_model)["Post"]

# Afficher le coefficient pour 'Post'
cat("Coefficient pour Post: ", post_coefficient, "\n")



```


```{r}
merged_US74 = merged_US74 %>% mutate(Time2Treatment = ifelse(treated==1, time-TreatmentPeriod, -1000))
est_did = feols(Outcome ~ i(Time2Treatment, ref = c(-1, -1000)) | id + time + Group, merged_US74)

iplot(est_did)
```










